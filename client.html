<html>
	<head>
		<title>Client to test</title>
		<script>

			function clearUserList() {
				var list = document.getElementById("userList");

				while (list.firstChild) {
					list.removeChild(list.firstChild);
				}

			}

			function setNewItem(uid, fname, lname) {
				var list = document.getElementById("userList");
				var newItem = document.createElement("div");

				newItem.setAttribute("class", "item");
				newItem.innerHTML = uid + " : " + fname + " " + lname;

				list.appendChild(newItem);
			}

			function getUsers() {
				let xhr = new XMLHttpRequest();
				var n = document.getElementById("filter1").options.selectedIndex;
				var filter = document.getElementById("filter1").options[n].value;
				xhr.open("GET", "http://localhost:3000/users/?filter=" + filter);
				// xhr.responseType = 'json';
				console.log("tx: get users, filter = " + filter)
				xhr.send();
				xhr.onload = function() {
					if (xhr.response) {
						var requestAsync = JSON.parse(xhr.response);
					} else {
						var requestAsync = "";
					}
					console.log("rx: " + xhr.status + " : " + xhr.response);

					if (xhr.status != 200 && xhr.status != 201) {
						document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
						document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
						document.getElementById("responseField").innerHTML = "";
						return
					}

					if (requestAsync.error) {
						document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : " + requestAsync.error + " "
					} else {
						document.getElementById("errorField").innerHTML = ""
					}

					clearUserList();

					for (i=0; requestAsync[i]; i++) {
						setNewItem(requestAsync[i].uid, requestAsync[i].fname, requestAsync[i].lname)
					}
				}
			}

			function wsConnect(uid, token) {
				let socket = new WebSocket("ws://localhost:3000/ws/?uid="+uid+"&ws-auth-token="+token)
				console.log("attempting websocket connection")

				socket.onopen = function() {
					console.log("web socket successfully connected")
					socket.send("hello from client")
				}

				socket.onclose = function(event) {
					console.log("Socket was closed: ", event)
				}

				socket.onerror = function(error) {
					console.log("socket error: ", error)
				}

				socket.onmessage = function(message) {
					console.log("server said: ", message.data)
				}
			}

			function AuthUser() {

				var mail = document.forms['auth']['mail'].value
				var passwd = document.forms['auth']['passwd'].value
				var request = JSON.stringify({ "mail": mail, "passwd": passwd })

				let xhr = new XMLHttpRequest();
				xhr.open("POST", "http://localhost:3000/auth/");
				xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

				console.log("tx: " + request)

				xhr.send(request)

				xhr.onload = function() {
					if (xhr.response) {
						var requestAsync = JSON.parse(xhr.response);
					} else {
						var requestAsync = "";
					}
					console.log("rx: " + xhr.status + " : " + xhr.response);

					if (xhr.status != 200) {
						document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
						document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
						document.getElementById("responseField").innerHTML = "";
						return
					}

					if (!requestAsync) {
						document.getElementById("errorField").innerHTML = "Empty request. Its not a valid case";
						document.getElementById("responseField").innerHTML = "";
						return
					}
					document.getElementById("errorField").innerHTML = ""

					if (!requestAsync.uid || !requestAsync.mail || !requestAsync["x-auth-token"] || !requestAsync["ws-auth-token"]) {
						document.getElementById("errorField").innerHTML += "uid or tokens are empty. Its not a valid case";
						return
					}

					document.getElementById("responseField").innerHTML = "uid=" + requestAsync.uid +
																		" mail=" + requestAsync.mail +
																		" x-auth-token=hidden ws-auth-token=hidden"
					document.forms['auth']['mail'].value = "";
					document.forms['auth']['passwd'].value = "";
					document.token = requestAsync["x-auth-token"]

					wsConnect(requestAsync.uid, requestAsync["ws-auth-token"])
				}

				xhr.onerror = function() {
					console.log("onError event")
				}
			}

			function RegUser() {

				var mail = document.forms['reg']['mail'].value
				var passwd = document.forms['reg']['passwd'].value
				var request = JSON.stringify({ "mail": mail, "passwd": passwd })

				let xhr = new XMLHttpRequest();
				xhr.open("POST", "http://localhost:3000/user/");

				console.log("tx: " + request)

				xhr.send(request);

				xhr.onload = function() {

					if (xhr.response) {
						var requestAsync = JSON.parse(xhr.response);
					} else {
						var requestAsync = "";
					}
					console.log("rx: " + xhr.status + " : " + xhr.response);

					if (xhr.status != 201) {
						document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
						document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
						document.getElementById("responseField").innerHTML = "";
						return
					}
					document.getElementById("errorField").innerHTML = ""
					document.getElementById("responseField").innerHTML = "registration was done. Check your email"
					document.forms['reg']['mail'].value = "";
					document.forms['reg']['passwd'].value = "";
				}

				xhr.onerror = function() {
					console.log("onError event")
				}
			}

			function UpdateUser() {
				var mail = document.forms['upd']['mail'].value
				var passwd = document.forms['upd']['passwd'].value
				var fname = document.forms['upd']['fname'].value
				var lname = document.forms['upd']['lname'].value
				var age = document.forms['upd']['age'].value
				var gender = document.forms['upd']['gender'].value
				var request = ""

				if (mail == "" && passwd == "" && fname == "" && lname == "" &&
						age == "" && gender == "") {
					console.log("update: all fields are empty")
					return
				}

				if (mail != "") {
					request = "\"mail\":"+JSON.stringify(mail)
				}
				if (passwd != "") {
					if (request != "") {
						request += ","
					}
					request += "\"passwd\":"+JSON.stringify(passwd)
				}
				if (fname != "") {
					if (request != "") {
						request += ","
					}
					request += "\"fname\":"+JSON.stringify(fname)
				}
				if (lname != "") {
					if (request != "") {
						request += ","
					}
					request += "\"lname\":"+JSON.stringify(lname)
				}
				if (age != "") {
					if (request != "") {
						request += ","
					}
					var validAge = Number(age)
					request += "\"age\":"+JSON.stringify(validAge)
				}
				if (gender != "") {
					if (request != "") {
						request += ","
					}
					request += "\"gender\":"+JSON.stringify(gender)
				}
				request = "{"+request+"}"

				let xhr = new XMLHttpRequest();
				xhr.open("PATCH", "http://localhost:3000/user/");
				xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
				xhr.setRequestHeader("x-auth-token", document.token);

				console.log("tx: " + request)

				xhr.send(request);

				xhr.onload = function() {

					if (xhr.response) {
						var requestAsync = JSON.parse(xhr.response);
					} else {
						var requestAsync = "";
					}
					console.log("rx: " + xhr.status + " : " + xhr.response);

					if (xhr.status != 200) {
						document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
						document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
						document.getElementById("responseField").innerHTML = "";
						return
					}
					document.getElementById("errorField").innerHTML = ""
					document.getElementById("responseField").innerHTML = "Update was done successfully"
					document.forms['upd']['mail'].value = "";
					document.forms['upd']['passwd'].value = "";
					document.forms['upd']['fname'].value = "";
					document.forms['upd']['lname'].value = "";
					document.forms['upd']['age'].value = "";
					document.forms['upd']['gender'].value = "";
				}

				xhr.onerror = function() {
					console.log("onError event")
				}
			}

			var token = ""

		</script>
		<style>
			.userList {
				border:		1px solid black;
				width:		500px;
			}
			.item {
				border:		1px solid red;
				width:		450px;
				margin:		2px auto 2px auto;
			}
			#responseField	{
				width:		600px;
				text-align: center;
				height:		22px;
				border:		3px solid green;
				margin:		10px auto 10px 10px;
			}
			#errorField {
				width:		600px;
				text-align: center;
				height:		22px;
				border:		3px solid red;
				margin:		10px auto 10px 10px;
			}
			input {
				display: block;
				margin:		10px;
			}
		</style>
	</head>
	<body>

		<div id="errorField">error Field</div>
		<div id="responseField">response will be here</div>
		<form name="auth">
			<input type="text" name="mail" placeholder="mail">
			<input type="password" name="passwd" placeholder="password">
		</form>
		<input type="submit" value="Авторизация" onclick="AuthUser()">

		<form name="reg">
			<input type="text" name="mail" placeholder="mail">
			<input type="password" name="passwd" placeholder="password">
		</form>
		<input type="submit" value="Регистрация" onclick="RegUser()">

		<form name="upd">
			<input type="text" name="mail" placeholder="mail">
			<input type="password" name="passwd" placeholder="password">
			<input type="text" name="fname" placeholder="first name">
			<input type="text" name="lname" placeholder="last name">
			<input type="text" name="age" placeholder="age">
			<input type="text" name="gender" placeholder="gender">
		</form>
		<input type="submit" value="Изменить данные" onclick="UpdateUser()">

		<p>
		<select size="1" id="filter1">
			<option selected value="all">Всех пользователей</option>
			<option value="logged">Только онлайн пользователей</option>
		</select>
		</p>

		<input type="submit" value="Показать пользователей" onclick="getUsers()">
		
		<div class="userList" id="userList">
		</div>

	</body>
</html>