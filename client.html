<html>

<head>
	<title>Client to test</title>
	<script>
		function b64DecodeUnicode(str) {
			// Going backwards: from bytestream, to percent-encoding, to original string.
			return decodeURIComponent(atob(str).split('').map(function (c) {
				return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
			}).join(''));
		}

		function b64EncodeUnicode(str) {
			// first we use encodeURIComponent to get percent-encoded UTF-8,
			// then we convert the percent encodings into raw bytes which
			// can be fed into btoa.
			return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
				function toSolidBytes(match, p1) {
					return String.fromCharCode('0x' + p1);
				}));
		}

		function clearUserList() {
			var list = document.getElementById("userList");

			while (list.firstChild) {
				list.removeChild(list.firstChild);
			}

		}

		function clearPhotoList() {
			var list = document.getElementById("photoList");

			while (list.firstChild) {
				list.removeChild(list.firstChild);
			}

		}

		function setNewItem(uid, fname, lname) {
			var list = document.getElementById("userList");
			var newItem = document.createElement("div");

			newItem.setAttribute("class", "item");
			newItem.innerHTML = uid + " : " + fname + " " + lname;

			list.appendChild(newItem);
		}

		function setNewPhoto(body) {
			var list = document.getElementById("photoList");
			var newPhoto = document.createElement("img");
			newPhoto.setAttribute("class", "photo");
			newPhoto.src = body

			list.appendChild(newPhoto);
		}

		function handleFilters() {
			var minAgeStr = document.forms['age']['min'].value
			var maxAgeStr = document.forms['age']['max'].value
			var minRatingStr = document.forms['rating']['min'].value
			var maxRatingStr = document.forms['rating']['max'].value
			var radLatitudeStr =  document.forms['location_radius']['latitude'].value
			var radLongitudeStr = document.forms['location_radius']['longitude'].value
			var radiusStr =       document.forms['location_radius']['radius'].value
			var interestsStr = document.forms['other']['interests'].value
			var filters = new Object();

			// handle age filter
			if (minAgeStr || maxAgeStr) {
				filters.age = {}
				if (minAgeStr) {
					filters.age.min = Number(minAgeStr)
				}
				if (maxAgeStr) {
					filters.age.max = Number(maxAgeStr)
				}
			}

			// handle rating filter
			if (minRatingStr || maxRatingStr) {
				filters.rating = {}
				if (minRatingStr) {
					filters.rating.min = Number(minRatingStr)
				}
				if (maxRatingStr) {
					filters.rating.max = Number(maxRatingStr)
				}
			}

			// handle location radius filter
			if (radLatitudeStr || radLongitudeStr || radiusStr) {
				filters.radius = {}
				if (radLatitudeStr) {
					filters.radius.latitude = Number(radLatitudeStr)
				}
				if (radLongitudeStr) {
					filters.radius.longitude = Number(radLongitudeStr)
				}
				if (radiusStr) {
					filters.radius.radius = Number(radiusStr)
				}
			}

			// handle interests filter
			if (interestsStr != "") {
				// результатом выражения является массив
				filters.interests = interestsStr.split(" ")
			}

			// handle online filter
			if (document.getElementById("online").checked) {
				filters.online = {}
			}
			return filters
		}

		function getUsers() {
			let xhr = new XMLHttpRequest();

			// var n = document.getElementById("filter1").options.selectedIndex;
			// var filter = document.getElementById("filter1").options[n].value;

			var filters = handleFilters()
			// let tokenObj = new Map()
			// tokenObj["x-auth-token"] = document.token
			// filters.push(tokenObj)
			filters["x-auth-token"] = document.token
			console.log(JSON.stringify(filters))
			// return

			xhr.open("POST", "http://localhost:3000/search/");
			// xhr.responseType = 'json';
			// console.log("tx: get users, filter = " + filter)
			xhr.send(JSON.stringify(filters));
			xhr.onload = function () {
				console.log("rx: " + xhr.status + " : " + xhr.response);
				if (xhr.response) {
					// console.log("response:")
					var requestAsync = JSON.parse(xhr.response);
					if (!requestAsync) {
						console.log("no users")
						return
					}
				} else {
					console.log("Empty response")
					return
					// var requestAsync = "";
				}

				if (xhr.status != 200 && xhr.status != 201) {
					document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
					document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
					document.getElementById("responseField").innerHTML = "";
					return
				}

				// if (!requestAsync) {
				// 	console.log("Empty response")
				// 	return
				// }
				if (requestAsync.error) {
					document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : " + requestAsync.error + " "
				} else {
					document.getElementById("errorField").innerHTML = ""
				}

				clearUserList();

				for (i = 0; requestAsync[i]; i++) {
					setNewItem(requestAsync[i].uid, requestAsync[i].fname, requestAsync[i].lname)
				}
			}
		}

		function wsConnect(uid, wsAuthToken) {
			let socket = new WebSocket("ws://localhost:3000/ws/auth/?uid=" + uid + "&ws-auth-token=" + wsAuthToken)
			console.log("attempting websocket connection")
			console.log("ws://localhost:3000/ws/auth/?uid=" + uid + "&ws-auth-token=" + wsAuthToken)

			socket.onopen = function () {
				console.log("web socket successfully connected")
				sendMessage()
			}

			socket.onclose = function (event) {
				console.log("Socket was closed: ", event)
			}

			socket.onerror = function (error) {
				console.log("socket error: ", error)
			}

			socket.onmessage = function (message) {
				console.log("rx: ", message.data)
			}

			function sendMessage() {
				message = `{"type":"message","uidReceiver":1,"body":"test message"}`
				console.log("tx: " + message)
				socket.send(message)
			}

			// setInterval(sendMessage, 7000)
		}

		function AuthUser() {

			var mail = document.forms['auth']['mail'].value
			var pass = document.forms['auth']['pass'].value
			var request = JSON.stringify({ "mail": mail, "pass": pass })

			let xhr = new XMLHttpRequest();
			xhr.open("POST", "http://localhost:3000/user/auth/");
			xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

			console.log("tx: " + request)

			xhr.send(request)

			xhr.onload = function () {
				if (xhr.response) {
					var requestAsync = JSON.parse(xhr.response);
				} else {
					var requestAsync = "";
				}
				console.log("rx: " + xhr.status + " : " + xhr.response);

				if (xhr.status != 200) {
					document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
					document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
					document.getElementById("responseField").innerHTML = "";
					return
				}

				if (!requestAsync) {
					document.getElementById("errorField").innerHTML = "Empty request. Its not a valid case";
					document.getElementById("responseField").innerHTML = "";
					return
				}
				document.getElementById("errorField").innerHTML = ""

				if (!requestAsync.uid || !requestAsync.mail || !requestAsync["x-auth-token"] || !requestAsync["ws-auth-token"]) {
					document.getElementById("errorField").innerHTML += "uid or tokens are empty. Its not a valid case";
					return
				}

				document.getElementById("responseField").innerHTML = "uid=" + requestAsync.uid +
					" mail=" + requestAsync.mail +
					" x-auth-token=hidden ws-auth-token=hidden"
				document.forms['auth']['mail'].value = "";
				document.forms['auth']['pass'].value = "";
				document.token = requestAsync["x-auth-token"]

				wsConnect(requestAsync.uid, requestAsync["ws-auth-token"])
			}

			xhr.onerror = function () {
				console.log("onError event")
			}
		}

		function RegUser() {

			var mail = document.forms['reg']['mail'].value
			var pass = document.forms['reg']['pass'].value
			var request = JSON.stringify({ "mail": mail, "pass": pass })

			let xhr = new XMLHttpRequest();
			xhr.open("POST", "http://localhost:3000/user/create/");

			console.log("tx: " + request)

			xhr.send(request);

			xhr.onload = function () {

				if (xhr.response) {
					var requestAsync = JSON.parse(xhr.response);
				} else {
					var requestAsync = "";
				}
				console.log("rx: " + xhr.status + " : " + xhr.response);

				if (xhr.status != 201) {
					document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
					document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
					document.getElementById("responseField").innerHTML = "";
					return
				}
				document.getElementById("errorField").innerHTML = ""
				document.getElementById("responseField").innerHTML = "registration was done. Check your email"
				document.forms['reg']['mail'].value = "";
				document.forms['reg']['pass'].value = "";
			}

			xhr.onerror = function () {
				console.log("onError event")
			}
		}

		function UpdateUserStatus() {
			var token = document.forms['updStatus']['x-reg-token'].value
			var request = `{"x-reg-token":"` + token + `"}`
			let xhr = new XMLHttpRequest();
			xhr.open("PATCH", "http://localhost:3000/user/update/status/");
			xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
			console.log("tx: " + request)
			xhr.send(request);

			xhr.onload = function () {

				if (xhr.response) {
					var requestAsync = JSON.parse(xhr.response);
				} else {
					var requestAsync = "";
				}
				console.log("rx: " + xhr.status + " : " + xhr.response);

				if (xhr.status != 200) {
					document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
					document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
					document.getElementById("responseField").innerHTML = "";
					return
				}
				document.getElementById("errorField").innerHTML = ""
				document.getElementById("responseField").innerHTML = "Update was done successfully"
				document.forms['updStatus']['x-reg-token'].value = "";
			}

			xhr.onerror = function () {
				console.log("onError event")
			}
		}

		function readURL(input) {
			if (input.files && input.files[0]) {
				var reader = new FileReader();
				image = document.getElementById('uploadPhoto');
				image.style.display = "block";
				// document.getElementById('video').style.opacity = 0;
				reader.onload = function (e) {
					image.setAttribute('src', e.target.result);
				};
				reader.readAsDataURL(input.files[0]);
			}
			image_statut = true;
		}

		function Upload() {
			var image = document.getElementById('uploadPhoto');

			var request = `{"x-auth-token":"` + document.token + `","src":"` + image.src + `"}` //btoa(image.src)
			document.buffer = image.src


			let xhr = new XMLHttpRequest();
			xhr.open("POST", "http://localhost:3000/photo/upload/");
			xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

			console.log("upload tx (not display img source)")
			xhr.send(request);

			xhr.onload = function () {

				if (xhr.response) {
					var requestAsync = JSON.parse(xhr.response);
				} else {
					var requestAsync = "";
				}
				console.log("upload rx: " + xhr.status + " : " + xhr.response);

				if (xhr.status != 200) {
					document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
					document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
					document.getElementById("responseField").innerHTML = "";
					return
				}
				document.getElementById("errorField").innerHTML = ""
				document.getElementById("responseField").innerHTML = "Upload was done successfully"
			}

			xhr.onerror = function () {
				console.log("onError event")
			}
		}

		function Download() {
			var uid = document.forms['dload']['uid'].value
			var request = `{"x-auth-token":"` + document.token + `","uid":` + uid + `}`

			let xhr = new XMLHttpRequest();
			xhr.open("POST", "http://localhost:3000/photo/download/");
			xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

			console.log("download tx: " + request)
			xhr.send(request);

			xhr.onload = function () {

				if (xhr.response) {
					var responseAsync = JSON.parse(xhr.response);
				} else {
					var responseAsync = "";
				}

				if (xhr.status != 200) {
					document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
					document.getElementById("errorField").innerHTML += ((responseAsync.error) ? responseAsync.error : xhr.statusText)
					document.getElementById("responseField").innerHTML = "";
					return
				}
				if (responseAsync) {//atob()
					clearPhotoList()
					for (i = 0; responseAsync[i]; i++) {
						console.log("download rx: pid=" + JSON.stringify(responseAsync[i].pid) + " uid=" + JSON.stringify(responseAsync[i].uid))
						setNewPhoto(responseAsync[i].src)
					}
				}
			}

			xhr.onerror = function () {
				console.log("onError event")
			}
		}

		function UpdateUser() {
			var mail = document.forms['upd']['mail'].value
			var pass = document.forms['upd']['pass'].value
			var fname = document.forms['upd']['fname'].value
			var lname = document.forms['upd']['lname'].value
			var birth = document.forms['upd']['birth'].value
			var gender = document.forms['upd']['gender'].value
			var orientation = document.forms['upd']['orientation'].value
			var bio = document.forms['upd']['bio'].value
			var avaID = document.forms['upd']['avaID'].value
			var latitude = document.forms['upd']['latitude'].value
			var longitude = document.forms['upd']['longitude'].value
			var interestsString = document.forms['upd']['interests'].value
			var interestsArr = interestsString.split(" ")
			var request = ""

			if (mail == "" && pass == "" && fname == "" && lname == "" &&
				birth == "" && gender == "" && orientation == "" && bio == "" &&
				avaID == "" && latitude == "" && longitude == "" && interestsString == "") {
				console.log("update: all fields are empty")
				return
			}

			if (mail != "") {
				request = "\"mail\":" + JSON.stringify(mail)
			}
			if (pass != "") {
				if (request != "") {
					request += ","
				}
				request += "\"pass\":" + JSON.stringify(pass)
			}
			if (fname != "") {
				if (request != "") {
					request += ","
				}
				request += "\"fname\":" + JSON.stringify(fname)
			}
			if (lname != "") {
				if (request != "") {
					request += ","
				}
				request += "\"lname\":" + JSON.stringify(lname)
			}
			if (birth != "") {
				if (request != "") {
					request += ","
				}
				request += "\"birth\":" + JSON.stringify(birth)
			}
			if (gender != "") {
				if (request != "") {
					request += ","
				}
				request += "\"gender\":" + JSON.stringify(gender)
			}
			if (orientation != "") {
				if (request != "") {
					request += ","
				}
				request += "\"orientation\":" + JSON.stringify(orientation)
			}
			if (bio != "") {
				if (request != "") {
					request += ","
				}
				request += "\"bio\":" + JSON.stringify(bio)
			}
			if (avaID != "") {
				if (request != "") {
					request += ","
				}
				var validAvaID = Number(avaID)
				request += "\"avaID\":" + JSON.stringify(validAvaID)
			}
			if (latitude != "") {
				if (request != "") {
					request += ","
				}
				request += "\"latitude\":" + latitude
			}
			if (longitude != "") {
				if (request != "") {
					request += ","
				}
				request += "\"longitude\":" + longitude
			}
			if (interestsString != "") {
				if (request != "") {
					request += ","
				}
				request += "\"interests\":" + JSON.stringify(interestsArr)
			}
			if (request != "") {
				request += ","
			}
			request += `"x-auth-token":"` + document.token + `"`
			request = "{" + request + "}"

			let xhr = new XMLHttpRequest();
			xhr.open("PATCH", "http://localhost:3000/user/update/");
			xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

			console.log("tx: " + request)

			xhr.send(request);

			xhr.onload = function () {

				if (xhr.response) {
					var requestAsync = JSON.parse(xhr.response);
				} else {
					var requestAsync = "";
				}
				console.log("rx: " + xhr.status + " : " + xhr.response);

				if (xhr.status != 200) {
					document.getElementById("errorField").innerHTML = "Что-то пошло не так: " + xhr.status + " : "
					document.getElementById("errorField").innerHTML += ((requestAsync.error) ? requestAsync.error : xhr.statusText)
					document.getElementById("responseField").innerHTML = "";
					return
				}
				document.getElementById("errorField").innerHTML = ""
				document.getElementById("responseField").innerHTML = "Update was done successfully"
				document.forms['upd']['mail'].value = "";
				document.forms['upd']['pass'].value = "";
				document.forms['upd']['fname'].value = "";
				document.forms['upd']['lname'].value = "";
				document.forms['upd']['birth'].value = "";
				document.forms['upd']['gender'].value = "";
				document.forms['upd']['orientation'].value = "";
				document.forms['upd']['bio'].value = "";
				document.forms['upd']['avaID'].value = "";
				document.forms['upd']['latitude'].value = "";
				document.forms['upd']['longitude'].value = "";
			}

			xhr.onerror = function () {
				console.log("onError event")
			}
		}

		var token = ""
		var buffer = ""

	</script>
	<style>
		.userList {
			border: 1px solid black;
			width: 500px;
		}

		.photoList {
			border: 3px solid brown;
			width: 500px;
		}

		.photo {
			display: block;
			width: 400px;
			margin: 2px auto 2px auto;
		}

		.item {
			border: 1px solid red;
			width: 450px;
			margin: 2px auto 2px auto;
		}

		#responseField {
			width: 600px;
			text-align: center;
			height: 22px;
			border: 3px solid green;
			margin: 10px auto 10px 10px;
		}

		#errorField {
			width: 600px;
			text-align: center;
			height: 22px;
			border: 3px solid red;
			margin: 10px auto 10px 10px;
		}

		input {
			display: block;
			margin: 10px;
		}

		/* .filter_form {
			display: block;
			border: 1px solid brown;
		} */

		.filter_input {
			display: block;
			height:  25px;
			width:   95%;
			margin:  10px auto 10px auto;
		}

		.label {
			display: block;
			height:  25px;
			width:   90%;
			margin:  10px auto auto auto;
			/* border: 1px solid brown; */
		}

		.checkbox {
			display: inline-block;
			height:  25px;
			width:   25px;
			margin:  auto auto auto auto;
			padding: 0;
			/* border: 1px solid brown; */
		}

		.checkbox_name {
			display: inline;
			position: relative;
			top: -8px;
			/* border: 1px solid brown; */
		}

		.filters_grid {
			display: grid;
			grid-template-columns:	repeat(4, 1fr);
			width:650px;
			border: 1px solid green;
		}
	</style>
</head>

<body>

	<div id="errorField">error Field</div>
	<div id="responseField">response will be here</div>

	<form title="choose your file">
		<input type="file" accept="image/*" onchange="readURL(this);">
	</form>

	<input type="submit" value="Upload" onclick="Upload()">

	<form name="dload">
		<input type="text" name="uid" placeholder="uid of photo author">
	</form>

	<input type="submit" value="Download" onclick="Download()">

	<form name="auth">
		<input type="text" name="mail" placeholder="mail">
		<input type="password" name="pass" placeholder="password">
	</form>
	<input type="submit" value="Авторизация" onclick="AuthUser()">

	<form name="reg">
		<input type="text" name="mail" placeholder="mail">
		<input type="password" name="pass" placeholder="password">
	</form>
	<input type="submit" value="Регистрация" onclick="RegUser()">

	<form name="updStatus">
		<input type="text" name="x-reg-token" placeholder="x-reg-token">
	</form>
	<input type="submit" value="Валидация почты" onclick="UpdateUserStatus()">

	<form name="upd">
		<input type="text" name="mail" placeholder="mail">
		<input type="password" name="pass" placeholder="password">
		<input type="text" name="fname" placeholder="first name">
		<input type="text" name="lname" placeholder="last name">
		<input type="text" name="birth" placeholder="birth date">
		<input type="text" name="gender" placeholder="gender">
		<input type="text" name="orientation" placeholder="orientation">
		<input type="text" name="bio" placeholder="biography">
		<input type="text" name="avaID" placeholder="avaID">
		<input type="text" name="latitude" placeholder="latitude">
		<input type="text" name="longitude" placeholder="longitude">
		<input type="text" name="interests" placeholder="interests">
	</form>
	<input type="submit" value="Изменить данные" onclick="UpdateUser()">

	<!-- <p>
		<select size="1" id="filter1">
			<option selected value="all">Всех пользователей</option>
			<option value="logged">Только онлайн пользователей</option>
		</select>
	</p> -->
	<div class="filters_grid">
		<form name="age" class="filter_form">
			<input type="text" class="filter_input" name="min" placeholder="мин возраст">
			<input type="text" class="filter_input" name="max" placeholder="макс возраст">
		</form>
		<form name="rating" class="filter_form">
			<input type="text" class="filter_input" name="min" placeholder="мин рейтинг">
			<input type="text" class="filter_input" name="max" placeholder="макс рейтинг">
		</form>
		<form name="location_radius" class="filter_form">
			<input type="text" class="filter_input" name="latitude" placeholder="широта">
			<input type="text" class="filter_input" name="longitude" placeholder="долгота">
			<input type="text" class="filter_input" name="radius" placeholder="радиус (км)">
		</form>
		<form name="other" class="filter_form">
			<input type="text" class="filter_input" name="interests" placeholder="Интересы">
			<label class="label"><input type="checkbox" class="checkbox" id="online">
				<div class="checkbox_name">Онлайн</div>
			</label>
		</form>
	</div>

	<input type="submit" value="Показать пользователей" onclick="getUsers()">

	<div class="userList" id="userList">
	</div>
	<div class="photoList" id="photoList">
	</div>

	<img id="uploadPhoto">

</body>

</html>